# Habbit TrackIt Bot

## Установка и запуск

1. Перейти в нужную папку: `backend` или `bot`
2. Создать в ней виртуальное окружение

    ```shell
    # pip
    python -m venv .venv
    .venv/Scripts/activate
    pip install -r requirements.txt
   
    # uv
    uv venv
    .venv/Scripts/activate
    uv sync
    ```

3. Пометить папку `src` как Root
4. Запустить `src/main.py`

## Настройки конфигурации

### Переменные окружения

Библиотека `Pydantic Settings` позволяет приоритизировать файлы переменных окружения.
Если пользователь **не создал** `.env`, pydantic заберет переменные из `.env.example`, что удобно для первых запусков.

Однако, рано или поздно переменные придется заменять, и для того, чтобы сохранить `.env.example` как _пример_
для всех разработчиков, **необходимо создать свой** `.env` файл. Сделать это можно так:

```shell
cp .env.example .env
```

Все заданные значения в `.env` будут иметь **_наибольший_** приоритет для запуска (так же для `docker-compose.yml` 
о котором мы поговорим дальше).

## Докер

Чтобы запустить базу данных, необходимо поднять соотвествующий контейнер с помощью docker-compose

   ```shell
   # Для DEV среды:
   docker compose up -d db
   python src/main.py
   
   # Для TEST среды:
   docker compose up -d test_db
   pytest -v 
   ```

> Запустить сразу _две_ базы данных нельзя

## Тесты

Для запуска тестов необходимо:

- Поднять тестовую базу данных: test_db
- Изменить переменные окружения
- Запустить тесты

### Тестовая база данных

Тестовая база данных используется для безопасной прогонки тестов, вне самого приложения. 

В файле `docker-compose.yml` прописан сервис `test_db` для прогонки тестов. Чтобы его запустить необходимо
прописать команду:

```shell
docker compose up -d test_db
```

### Переменные окружения для тестов

В первой фикстуре, в файле `tests/conftest.py` прописана логика для самопроверки, чтобы случайно не прогнать тесты на 
основной бд:

```shell
assert settings.run.mode == "TEST"
assert "pytest" in settings.db.name or "test" in settings.db.name
```

Разберем последовательно:

1. Первая строчка проверяет установленную **среду запуска приложения**. Необходимо заменить переменную `RUN__MODE` на 
`TEST`.

   > Среда запуска `TEST` не позволяет запускать FastAPI приложение. Вылетит ошибка:
   > ```
   > Нельзя запустить приложение в тестовой среде. 
   > Переключите RUN__MODE на DEV или протестируйте приложение с pytest
   > ```

2. Вторая строчка проверяет действительно ли нужная база используется для тестов за счет слов `pytest` или `test` в 
названии базы.

### Запуск тестов

Теперь мы перешли к самому сладенькому - запуск. 

Для запуска тестов используются команды:

```shell
# Запускает все тесты
pytest          

# Дополнительно выводит print'ы  
pytest -s         

# Красиво расписывает каждый тест и вместо точек пишет полноценно PASSED, ERROR или FAILED
pytest -v 

# Запускает только конкретные тесты
pytest tests/path/to/test 
```